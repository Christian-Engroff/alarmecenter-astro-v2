---
import Layout from '../components/Layout.astro';
import { fetchProducts, fetchProductCategories } from '../lib/wordpress';

// Test API connection
let products = [];
let categories = [];
let apiStatus = 'disconnected';

try {
  products = await fetchProducts();
  categories = await fetchProductCategories();
  apiStatus = 'connected';
} catch (error) {
  console.error('API Error:', error);
  apiStatus = 'error';
}
---

<Layout 
  title="AlarmeCenter - Teste de Conex√£o"
  description="Teste da base do projeto Astro + WordPress"
>
  <div class="min-h-screen bg-gray-50">
    <!-- Header Simples -->
    <header class="bg-white shadow-sm">
      <div class="container mx-auto px-4 py-6">
        <h1 class="text-3xl font-bold text-brand-primary">
          üöÄ AlarmeCenter - Base Astro
        </h1>
        <p class="text-gray-600 mt-2">Teste de conex√£o com WordPress GraphQL</p>
      </div>
    </header>

    <!-- Status da API -->
    <section class="container mx-auto px-4 py-8">
      <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-xl font-semibold mb-4">üîç Status da Conex√£o</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <!-- API Status -->
          <div class="text-center p-4 rounded-lg border">
            <div class={`text-2xl mb-2 ${apiStatus === 'connected' ? 'text-green-500' : 'text-red-500'}`}>
              {apiStatus === 'connected' ? '‚úÖ' : '‚ùå'}
            </div>
            <h3 class="font-semibold">API WordPress</h3>
            <p class="text-sm text-gray-600 capitalize">{apiStatus}</p>
          </div>

          <!-- Products Count -->
          <div class="text-center p-4 rounded-lg border">
            <div class="text-2xl mb-2 text-blue-500">üì¶</div>
            <h3 class="font-semibold">Produtos</h3>
            <p class="text-sm text-gray-600">{products.length} encontrados</p>
          </div>

          <!-- Categories Count -->
          <div class="text-center p-4 rounded-lg border">
            <div class="text-2xl mb-2 text-purple-500">üè∑Ô∏è</div>
            <h3 class="font-semibold">Categorias</h3>
            <p class="text-sm text-gray-600">{categories.length} encontradas</p>
          </div>
        </div>
      </div>

      <!-- Products Preview -->
      {products.length > 0 && (
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
          <h2 class="text-xl font-semibold mb-4">üõçÔ∏è Produtos (Preview)</h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            {products.slice(0, 3).map(product => (
              <div class="border rounded-lg p-4" key={product.id}>
                <img 
                  src={product.image?.sourceUrl || '/placeholder-product.svg'}
                 // /* src={product.image.sourceUrl} */
                  alt={product.name}
                  class="w-full h-32 object-cover rounded mb-3"
                  onerror="this.src='/placeholder-product.svg'"
                />
                <h3 class="font-semibold text-sm mb-2">{product.name}</h3>
                <p class="text-brand-primary font-bold">{product.price}</p>
                <p class="text-xs text-gray-500">SKU: {product.sku || 'N/A'}</p>
              </div>
            ))}
          </div>
        </div>
      )}

      <!-- Categories Preview -->
      {categories.length > 0 && (
        <div class="bg-white rounded-lg shadow-md p-6">
          <h2 class="text-xl font-semibold mb-4">üìã Categorias (Preview)</h2>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            {categories.slice(0, 8).map(category => (
              <div class="border rounded-lg p-3 text-center">
                <h4 class="font-medium text-sm">{category.name}</h4>
                <p class="text-xs text-gray-500">{category.count} produtos</p>
              </div>
            ))}
          </div>
        </div>
      )}

      <!-- Debug Info -->
      <div class="mt-8 bg-gray-100 rounded-lg p-4">
        <details>
          <summary class="cursor-pointer font-semibold">üîß Debug Info</summary>
          <div class="mt-4 text-sm">
            <p><strong>Endpoint:</strong> {import.meta.env.WORDPRESS_API_URL}</p>
            <p><strong>Products Found:</strong> {products.length}</p>
            <p><strong>Categories Found:</strong> {categories.length}</p>
            <p><strong>Build Time:</strong> {new Date().toLocaleString('pt-BR')}</p>
          </div>
        </details>
      </div>
    </section>
  </div>
</Layout>