---
import { graphqlClient } from '../lib/wordpress';

let debugInfo = {
  endpoint: import.meta.env.WORDPRESS_API_URL,
  auth: !!import.meta.env.WORDPRESS_USERNAME,
  availableFields: null,
  posts: null,
  pages: null,
  categories: null,
  error: null
};

try {
  // Test 1: Discover available fields
  console.log('üîç Testing schema introspection...');
  const schemaQuery = `
    query IntrospectionQuery {
      __schema {
        queryType {
          fields {
            name
            description
          }
        }
      }
    }
  `;
  
  try {
    const schemaResult = await graphqlClient.request(schemaQuery);
    debugInfo.availableFields = schemaResult.__schema?.queryType?.fields?.map(f => f.name) || [];
  } catch (schemaError) {
    console.log('Schema introspection failed, testing basic queries...');
  }

  // Test 2: Try basic WordPress queries
  const basicQuery = `
    query BasicTest {
      posts(first: 3) {
        nodes {
          id
          title
          slug
          excerpt
          date
        }
      }
      categories(first: 5) {
        nodes {
          id
          name
          slug
          count
        }
      }
      pages(first: 3) {
        nodes {
          id
          title
          slug
          content
        }
      }
    }
  `;
  
  const basicResult = await graphqlClient.request(basicQuery);
  debugInfo.posts = basicResult.posts?.nodes || [];
  debugInfo.categories = basicResult.categories?.nodes || [];
  debugInfo.pages = basicResult.pages?.nodes || [];

} catch (error) {
  debugInfo.error = error.message;
  console.error('All queries failed:', error);
}
---

<html>
<head>
  <title>Debug GraphQL Schema</title>
  <style>
    body { font-family: monospace; padding: 20px; background: #f5f5f5; line-height: 1.6; }
    pre { background: white; padding: 15px; border-radius: 5px; overflow-x: auto; white-space: pre-wrap; }
    .error { color: red; background: #fee; padding: 10px; border-radius: 5px; margin: 10px 0; }
    .success { color: green; background: #efe; padding: 10px; border-radius: 5px; margin: 10px 0; }
    .info { background: #e3f2fd; padding: 10px; border-radius: 5px; margin: 10px 0; }
    h1, h2 { color: #333; }
    .field-list { background: white; padding: 15px; border-radius: 5px; margin: 10px 0; }
    .field-list ul { columns: 3; column-gap: 20px; }
    .field-list li { break-inside: avoid; padding: 2px 0; }
  </style>
</head>
<body>
  <h1>üîç Schema Discovery - WordPress GraphQL</h1>
  
  <div class="info">
    <strong>Endpoint:</strong> {debugInfo.endpoint}<br>
    <strong>Authentication:</strong> {debugInfo.auth ? '‚úÖ Configured' : '‚ùå Missing'}<br>
    <strong>Test Time:</strong> {new Date().toLocaleString('pt-BR')}
  </div>

  {debugInfo.availableFields && (
    <div class="success">
      <h2>‚úÖ Available GraphQL Fields ({debugInfo.availableFields.length}):</h2>
      <div class="field-list">
        <ul>
          {debugInfo.availableFields.map(field => (
            <li>‚Ä¢ {field}</li>
          ))}
        </ul>
      </div>
    </div>
  )}

  {debugInfo.posts && debugInfo.posts.length > 0 && (
    <div class="success">
      <h2>üìù Posts Found ({debugInfo.posts.length}):</h2>
      <pre>{JSON.stringify(debugInfo.posts, null, 2)}</pre>
    </div>
  )}

  {debugInfo.categories && debugInfo.categories.length > 0 && (
    <div class="success">
      <h2>üè∑Ô∏è Categories Found ({debugInfo.categories.length}):</h2>
      <pre>{JSON.stringify(debugInfo.categories, null, 2)}</pre>
    </div>
  )}

  {debugInfo.pages && debugInfo.pages.length > 0 && (
    <div class="success">
      <h2>üìÑ Pages Found ({debugInfo.pages.length}):</h2>
      <pre>{JSON.stringify(debugInfo.pages, null, 2)}</pre>
    </div>
  )}

  {debugInfo.error && (
    <div class="error">
      <h2>‚ùå Error Details:</h2>
      <pre>{debugInfo.error}</pre>
    </div>
  )}

  <!-- Test different authentication -->
  <div class="info">
    <h2>üîß Possible Solutions:</h2>
    <ol>
      <li><strong>WooCommerce not installed:</strong> This might be a regular WordPress without WooCommerce</li>
      <li><strong>WP GraphQL WooCommerce missing:</strong> Plugin not installed or activated</li>
      <li><strong>Authentication issue:</strong> Different auth method required</li>
      <li><strong>Different field names:</strong> API might use custom field names</li>
    </ol>
  </div>

  <div style="margin-top: 30px; padding: 20px; background: #f0f8ff; border-radius: 5px;">
    <h3>üöÄ Next Steps:</h3>
    <p>Based on the results above, we can:</p>
    <ul>
      <li>‚úÖ Use <code>posts</code> and <code>categories</code> if this is a blog-focused site</li>
      <li>‚úÖ Install WooCommerce + WP GraphQL plugins if it's meant to be an e-commerce</li>
      <li>‚úÖ Adapt queries to work with available fields</li>
    </ul>
  </div>
</body>
</html>